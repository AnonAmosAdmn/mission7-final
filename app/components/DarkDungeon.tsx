"use client";
import { useEffect, useRef, useState } from 'react';
import { usePrivy,  CrossAppAccountWithMetadata } from '@privy-io/react-auth';
import { ScoreSubmissionManager } from '../lib/score-api';
import { GAME_CONFIG } from '../lib/game-config';

// Base64 sprite placeholders
const PLAYER_IMAGE = "data:image/png;base64,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"
const EXIT_IMAGE = "data:image/png;base64,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"
const POTION_IMAGE = "data:image/png;base64,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"
const WEAPON_IMAGE = "data:image/png;base64,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"
const ARMOR_IMAGE = "data:image/png;base64,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"
const GOLD_IMAGE="data:image/png;base64,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"


// Game constants
const GRID_SIZE = 32;
const SCREEN_WIDTH = 1600;
const SCREEN_HEIGHT = 1200;
const MINIMAP_WIDTH = 200;
const MINIMAP_HEIGHT = 200;
const MINIMAP_CELL_SIZE = 3;
const MINIMAP_POSITION = { x: SCREEN_WIDTH - MINIMAP_WIDTH - 10, y: 10 };

// Colors
const BLACK = '#000000';
const WHITE = '#FFFFFF';
const GREEN = '#32FF32';
const YELLOW = '#FFFF32';
const DARK_GRAY = '#323232';
const STONE = '#787878';

// Color palettes
const WALL_PALETTE = [
  '#787878', '#64503C', '#505A64', '#6E645A', '#5A5046', '#826E5A', 
  '#5F554B', '#555F55', '#695F6E', '#737D87', '#7D7369', '#464B50', 
  '#8C8278', '#50463C', '#646E69', '#5A0000', '#821414', '#500A0A', 
  '#64001E', '#3C0014', '#1E0000', '#781E1E', '#8C3232', '#460A28', 
  '#6E0000', '#320A0A', '#5A1E3C', '#643246', '#280505', '#46001E'
];

const FLOOR_PALETTE = [
  '#323232', '#3C3228', '#28323C', '#463C32', '#1E1E28', '#372D23', 
  '#2D3741', '#41372D', '#232832', '#4B4137', '#323C32', '#3C323C', 
  '#28281E', '#50463C', '#2D2319', '#414B55', '#140000', '#280A0A', 
  '#3C1423', '#320014', '#0A000A', '#1E0A0A', '#5A001E', '#140A05', 
  '#230F19', '#32141E', '#190505', '#5A2832'
];

// Helper function to load base64 images
function loadBase64Image(base64: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = base64;
  });
}

// A single tile on the game map
class Tile {
  x: number;
  y: number;
  type: number; // 0 = wall, 1 = floor, 2 = exit
  explored: boolean;
  visible: boolean;

  constructor(x: number, y: number, tileType: number) {
    this.x = x;
    this.y = y;
    this.type = tileType;
    this.explored = false;
    this.visible = false;
  }
}

// A rectangular room within the dungeon
class Room {
  x: number;
  y: number;
  w: number;
  h: number;
  center: [number, number];

  constructor(x: number, y: number, w: number, h: number) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.center = [x + Math.floor(w / 2), y + Math.floor(h / 2)];
  }

  intersects(other: Room): boolean {
    return (
      this.x < other.x + other.w &&
      this.x + this.w > other.x &&
      this.y < other.y + other.h &&
      this.y + this.h > other.y
    );
  }
}

// Represents any character or object in the game world
class Entity {
  x: number;
  y: number;
  char: string;
  color: string;
  name: string;
  sprite: HTMLImageElement | null;
  can_face_directions: boolean;

  constructor(x: number, y: number, char: string, color: string, name: string) {
    this.x = x;
    this.y = y;
    this.char = char;
    this.color = color;
    this.name = name;
    this.sprite = null;
    this.can_face_directions = false;
  }

  async loadSprite() {
    const spriteMapping: Record<string, string> = {
      "Player": PLAYER_IMAGE,
      "Exit": EXIT_IMAGE
    };

    if (spriteMapping[this.name]) {
      try {
        this.sprite = await loadBase64Image(spriteMapping[this.name]);
      } catch (error) {
        console.error(`Failed to load ${this.name} sprite:`, error);
      }
    }
  }

  draw(ctx: CanvasRenderingContext2D, x: number, y: number, size: number) {
    if (this.sprite) {
      ctx.drawImage(this.sprite, x, y, size, size);
    } else {
      ctx.fillStyle = this.color;
      ctx.font = `${size}px Arial`;
      ctx.fillText(this.char, x + size/4, y + size - size/4);
    }
  }
}

class Item extends Entity {
  type: string;
  value: number;

  constructor(x: number, y: number, type: string, value: number = 0) {
    let char, color, name;
    switch(type) {
      case "gold":
        char = "$";
        color = YELLOW;
        name = "Gold";
        break;
      case "potion":
        char = "!";
        color = "#FF0000";
        name = "Potion";
        break;
      case "weapon":
        char = "/";
        color = "#FFFFFF";
        name = "Weapon";
        break;
      case "armor":
        char = "[";
        color = "#00FFFF";
        name = "Armor";
        break;
      default:
        char = "?";
        color = WHITE;
        name = "Unknown";
    }
    
    super(x, y, char, color, name);
    this.type = type;
    this.value = value;
  }

  async loadSprite() {
    const spriteMapping: Record<string, string> = {
      "gold": GOLD_IMAGE,
      "potion": POTION_IMAGE,
      "weapon": WEAPON_IMAGE,
      "armor": ARMOR_IMAGE
    };

    if (spriteMapping[this.type]) {
      try {
        this.sprite = await loadBase64Image(spriteMapping[this.type]);
      } catch (error) {
        console.error(`Failed to load ${this.type} sprite:`, error);
      }
    }
  }
}

class Player extends Entity {
  last_direction: string;
  walletAddress: string;
  username: string;
  lastMoveTime: number = 0;
  moveCooldown: number = 100;
  gold: number;
  score: number;

  constructor(x: number, y: number, walletAddress: string, username: string = "") {
    super(x, y, "@", GREEN, "Player");
    this.walletAddress = walletAddress || "";
    this.username = username;
    this.can_face_directions = true;
    this.last_direction = "right";
    this.gold = 0;
    this.score = 0;
  }

  canMove(): boolean {
    return Date.now() - this.lastMoveTime > this.moveCooldown;
  }

  recordMove() {
    this.lastMoveTime = Date.now();
  }

  draw(ctx: CanvasRenderingContext2D, x: number, y: number, size: number) {
    if (this.sprite) {
      if (this.last_direction === "right") {
        ctx.save();
        ctx.translate(x + size, y);
        ctx.scale(-1, 1);
        ctx.drawImage(this.sprite, 0, 0, size, size);
        ctx.restore();
      } else {
        ctx.drawImage(this.sprite, x, y, size, size);
      }
    } else {
      ctx.fillStyle = this.color;
      ctx.font = `${size}px Arial`;
      ctx.fillText(this.char, x + size/4, y + size - size/4);
    }
  }
}

class Game {
  map_width: number;
  map_height: number;
  tiles: Tile[][];
  player: Player;
  exit: Entity;
  items: Item[];
  message: string;
  message_time: number;
  camera_x: number;
  camera_y: number;
  game_state: string;
  dungeon_level: number;
  wall_color: string;
  floor_color: string;
  game_over: boolean;
  gameDuration: number = 2 * 60 * 1000;
  gameStartTime: number = 0;
  timeRemaining: number = 0;
  timerInterval: NodeJS.Timeout | null = null;
  scoreManager: ScoreSubmissionManager | null = null;
  lastSubmittedScore: number = 0;
  isSubmittingScore: boolean = false;

  constructor(playerName: string, walletAddress?: string) {
    this.map_width = 100;
    this.map_height = 100;
    this.tiles = [];
    this.player = new Player(0, 0, walletAddress || playerName);
    this.exit = new Entity(0, 0, "E", YELLOW, "Exit");
    this.items = [];
    this.message = "";
    this.message_time = 0;
    this.camera_x = 0;
    this.camera_y = 0;
    this.game_state = "playing";
    this.dungeon_level = 1;
    this.wall_color = STONE;
    this.floor_color = DARK_GRAY;
    this.game_over = false;
    
    if (walletAddress) {
      this.scoreManager = new ScoreSubmissionManager(walletAddress);
    }
    
    this.startTimer();
    this.generate_dungeon();
  }

  startTimer() {
    this.gameStartTime = Date.now();
    this.timeRemaining = this.gameDuration;
    this.timerInterval = setInterval(() => this.updateTimer(), 1000);
  }

  updateTimer() {
    const elapsed = Date.now() - this.gameStartTime;
    this.timeRemaining = Math.max(0, this.gameDuration - elapsed);

    if (this.timeRemaining <= 0) {
      this.endGameFromTimer();
    }
  }

  endGameFromTimer() {
    if (this.timerInterval) {
      clearInterval(this.timerInterval);
      this.timerInterval = null;
    }
    this.gameOver();
  }

  async initializeSprites() {
    await Promise.all([
      this.player.loadSprite(),
      this.exit.loadSprite(),
      ...this.items.map(item => item.loadSprite())
    ]);
  }

  async gameOver() {
    if (this.timerInterval) {
      clearInterval(this.timerInterval);
      this.timerInterval = null;
    }
    this.game_over = true;
    this.game_state = "game_over";
    
    if (this.scoreManager && this.player.score > 0) {
      this.isSubmittingScore = true;
      try {
        // Submit any remaining score first
        if (this.player.score > this.lastSubmittedScore) {
          const scoreIncrease = this.player.score - this.lastSubmittedScore;
          this.scoreManager.addScore(scoreIncrease);
          this.scoreManager.addTransaction(1);
        }
        
        // Then submit final score
        const result = await this.scoreManager.submitImmediately();
        if (!result.success) {
          console.error('Failed to submit final score:', result.error);
        }
      } catch (error) {
        console.error('Score submission error:', error);
      } finally {
        this.isSubmittingScore = false;
      }
    }
  }

  async generate_dungeon() {
    this.wall_color = WALL_PALETTE[Math.floor(Math.random() * WALL_PALETTE.length)];
    this.floor_color = FLOOR_PALETTE[Math.floor(Math.random() * FLOOR_PALETTE.length)];
    
    while (this.colorDistance(this.wall_color, this.floor_color) < 60) {
      this.floor_color = FLOOR_PALETTE[Math.floor(Math.random() * FLOOR_PALETTE.length)];
    }
    
    this.tiles = Array(this.map_height).fill(0).map((_, y) => 
      Array(this.map_width).fill(0).map((_, x) => new Tile(x, y, 0))
    );
    
    const rooms: Room[] = [];
    const max_rooms = 20 + this.dungeon_level * 2;
    const min_room_size = 8;
    const max_room_size = 20;
    let player_placed = false;
    
    for (let i = 0; i < max_rooms; i++) {
      const w = Math.floor(Math.random() * (max_room_size - min_room_size + 1)) + min_room_size;
      const h = Math.floor(Math.random() * (max_room_size - min_room_size + 1)) + min_room_size;
      const x = Math.floor(Math.random() * (this.map_width - w - 1)) + 1;
      const y = Math.floor(Math.random() * (this.map_height - h - 1)) + 1;
      const new_room = new Room(x, y, w, h);
      
      let failed = false;
      for (const other_room of rooms) {
        if (new_room.intersects(other_room)) {
          failed = true;
          break;
        }
      }
      
      if (!failed) {
        this.carve_room(new_room);
        const [new_x, new_y] = new_room.center;
        
        if (!player_placed) {
          this.player.x = new_x;
          this.player.y = new_y;
          player_placed = true;
        } else {
          const prev_center = rooms[rooms.length - 1].center;
          if (Math.random() < 0.5) {
            this.carve_h_tunnel(prev_center[0], new_x, prev_center[1]);
            this.carve_v_tunnel(prev_center[1], new_y, new_x);
          } else {
            this.carve_v_tunnel(prev_center[1], new_y, prev_center[0]);
            this.carve_h_tunnel(prev_center[0], new_x, new_y);
          }
        }
        
        rooms.push(new_room);
      }
    }
    
    if (!player_placed) {
      this.player.x = 1;
      this.player.y = 1;
      this.tiles[1][1].type = 1;
    }
    
    if (rooms.length > 0) {
      const last_room = rooms[rooms.length - 1];
      this.exit.x = last_room.center[0];
      this.exit.y = last_room.center[1];
      this.tiles[this.exit.y][this.exit.x].type = 2;
    }
    
    this.items = [];
    const itemPromises: Promise<void>[] = [];
    
    for (let y = 0; y < this.map_height; y++) {
      for (let x = 0; x < this.map_width; x++) {
        if (this.tiles[y][x].type === 1) {
          if (Math.random() < 0.005) {
            const itemWeights = [
              { type: "gold", weight: 60 },
              { type: "potion", weight: 20 },
              { type: "weapon", weight: 10 },
              { type: "armor", weight: 10 }
            ];
            
            const totalWeight = itemWeights.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedType = "gold";
            
            for (const item of itemWeights) {
              if (random < item.weight) {
                selectedType = item.type;
                break;
              }
              random -= item.weight;
            }
            
            let value = 0;
            if (selectedType === "gold") {
              value = Math.floor(Math.random() * 10) + 1;
            }
            
            const item = new Item(x, y, selectedType, value);
            this.items.push(item);
            itemPromises.push(item.loadSprite().catch(e => 
              console.error(`Error loading sprite for ${item.name}:`, e))
            );
          }
        }
      }
    }
    
    await Promise.all(itemPromises);
    await Promise.all([
      this.player.loadSprite(),
      this.exit.loadSprite()
    ]);
    
    this.update_fov();
  }

  colorDistance(color1: string, color2: string): number {
    const r1 = parseInt(color1.substring(1, 3), 16);
    const g1 = parseInt(color1.substring(3, 5), 16);
    const b1 = parseInt(color1.substring(5, 7), 16);
    
    const r2 = parseInt(color2.substring(1, 3), 16);
    const g2 = parseInt(color2.substring(3, 5), 16);
    const b2 = parseInt(color2.substring(5, 7), 16);
    
    return Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
  }

  carve_room(room: Room) {
    for (let y = room.y + 1; y < room.y + room.h; y++) {
      for (let x = room.x + 1; x < room.x + room.w; x++) {
        this.tiles[y][x].type = 1;
      }
    }
  }

  carve_h_tunnel(x1: number, x2: number, y: number) {
    for (let x = Math.min(x1, x2); x <= Math.max(x1, x2); x++) {
      this.tiles[y][x].type = 1;
    }
  }

  carve_v_tunnel(y1: number, y2: number, x: number) {
    for (let y = Math.min(y1, y2); y <= Math.max(y1, y2); y++) {
      this.tiles[y][x].type = 1;
    }
  }

  update_fov() {
    for (let y = 0; y < this.map_height; y++) {
      for (let x = 0; x < this.map_width; x++) {
        this.tiles[y][x].visible = false;
      }
    }
    
    this.tiles[this.player.y][this.player.x].visible = true;
    this.tiles[this.player.y][this.player.x].explored = true;
    
    const radius = 6;
    for (let dy = -radius; dy <= radius; dy++) {
      for (let dx = -radius; dx <= radius; dx++) {
        const x = this.player.x + dx;
        const y = this.player.y + dy;
        
        if (x >= 0 && x < this.map_width && y >= 0 && y < this.map_height) {
          if (dx*dx + dy*dy <= radius*radius) {
            this.tiles[y][x].visible = true;
            this.tiles[y][x].explored = true;
          }
        }
      }
    }
  }

  update_camera() {
    this.camera_x = this.player.x * GRID_SIZE - SCREEN_WIDTH / 2;
    this.camera_y = this.player.y * GRID_SIZE - SCREEN_HEIGHT / 2;
    
    const max_x = this.map_width * GRID_SIZE - SCREEN_WIDTH;
    const max_y = this.map_height * GRID_SIZE - SCREEN_HEIGHT;
    this.camera_x = Math.max(0, Math.min(this.camera_x, max_x));
    this.camera_y = Math.max(0, Math.min(this.camera_y, max_y));
  }

  move_player(dx: number, dy: number) {
    if (!this.player.canMove() || this.game_over) return;
    
    const new_x = this.player.x + dx;
    const new_y = this.player.y + dy;
    
    if (dx > 0) {
      this.player.last_direction = "right";
    } else if (dx < 0) {
      this.player.last_direction = "left";
    }
    
    if (new_x < 0 || new_y < 0 || new_x >= this.map_width || new_y >= this.map_height) {
      this.message = "You can't go that way!";
      this.message_time = Date.now();
      return;
    }
    
    if (this.tiles[new_y][new_x].type === 0) {
      this.message = "You can't walk through walls!";
      this.message_time = Date.now();
      return;
    }
    
    const itemIndex = this.items.findIndex(item => item.x === new_x && item.y === new_y);
    if (itemIndex !== -1) {
      const item = this.items[itemIndex];
      
      if (item.type === "gold") {
        this.player.gold += item.value;
        const points = item.value * 10;
        this.player.score += points;
        this.message = `Picked up ${item.value} gold! (+${points} points)`;
        
        // Add to pending score for blockchain submission
        if (this.scoreManager) {
          this.scoreManager.addScore(points);
          this.scoreManager.addTransaction(1);
          this.lastSubmittedScore = this.player.score;
        }
      } else if (item.type === "potion") {
        const currentElapsed = Date.now() - this.gameStartTime;
        const newRemaining = (this.gameDuration - currentElapsed) + 30000;
        this.gameDuration = currentElapsed + newRemaining;
        const points = 50;
        this.player.score += points;
        this.message = `Picked up a time potion! (+30 sec) (+${points} points)`;
        
        if (this.scoreManager) {
          this.scoreManager.addScore(points);
          this.scoreManager.addTransaction(1);
          this.lastSubmittedScore = this.player.score;
        }
      } else {
        const points = {
          "weapon": 100,
          "armor": 100
        }[item.type] || 0;
        
        this.player.score += points;
        this.message = `Picked up ${item.name}! (+${points} points)`;
        
        if (this.scoreManager) {
          this.scoreManager.addScore(points);
          this.scoreManager.addTransaction(1);
          this.lastSubmittedScore = this.player.score;
        }
      }
      
      this.items.splice(itemIndex, 1);
      this.message_time = Date.now();
    }
    
    if (new_x === this.exit.x && new_y === this.exit.y) {
      const exitPoints = 500 * this.dungeon_level;
      this.player.score += exitPoints;
      this.dungeon_level += 1;
      this.message = `Descending to dungeon level ${this.dungeon_level}! (+${exitPoints} points)`;
      this.message_time = Date.now();
      
      if (this.scoreManager) {
        this.scoreManager.addScore(exitPoints);
        this.scoreManager.addTransaction(1);
        this.lastSubmittedScore = this.player.score;
      }
      
      this.generate_dungeon();
      return;
    }
    
    this.player.x = new_x;
    this.player.y = new_y;
    this.player.recordMove();
    this.update_fov();
  }

  draw(ctx: CanvasRenderingContext2D) {
    ctx.fillStyle = BLACK;
    ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
    
    if (this.game_over) {
      this.drawGameOverScreen(ctx);
      return;
    }
    
    const start_x = Math.max(0, Math.floor(this.camera_x / GRID_SIZE));
    const start_y = Math.max(0, Math.floor(this.camera_y / GRID_SIZE));
    const end_x = Math.min(this.map_width, Math.ceil((this.camera_x + SCREEN_WIDTH) / GRID_SIZE) + 1);
    const end_y = Math.min(this.map_height, Math.ceil((this.camera_y + SCREEN_HEIGHT) / GRID_SIZE) + 1);
    
    for (let y = start_y; y < end_y; y++) {
      for (let x = start_x; x < end_x; x++) {
        const screen_x = x * GRID_SIZE - this.camera_x;
        const screen_y = y * GRID_SIZE - this.camera_y;
        const tile = this.tiles[y][x];
        
        if (tile.visible) {
          if (tile.type === 0) {
            ctx.fillStyle = this.wall_color;
            ctx.fillRect(screen_x, screen_y, GRID_SIZE, GRID_SIZE);
          } else if (tile.type === 1) {
            ctx.fillStyle = this.floor_color;
            ctx.fillRect(screen_x, screen_y, GRID_SIZE, GRID_SIZE);
          } else if (tile.type === 2) {
            ctx.fillStyle = this.floor_color;
            ctx.fillRect(screen_x, screen_y, GRID_SIZE, GRID_SIZE);
          }
        } else if (tile.explored) {
          if (tile.type === 0) {
            ctx.fillStyle = this.darkenColor(this.wall_color);
            ctx.fillRect(screen_x, screen_y, GRID_SIZE, GRID_SIZE);
          } else if (tile.type === 1 || tile.type === 2) {
            ctx.fillStyle = this.darkenColor(this.floor_color);
            ctx.fillRect(screen_x, screen_y, GRID_SIZE, GRID_SIZE);
          }
        }
      }
    }
    
    for (const item of this.items) {
      if (this.tiles[item.y][item.x].visible) {
        const item_x = item.x * GRID_SIZE - this.camera_x;
        const item_y = item.y * GRID_SIZE - this.camera_y;
        item.draw(ctx, item_x, item_y, GRID_SIZE);
      }
    }
    
    if (this.tiles[this.exit.y][this.exit.x].visible) {
      const exit_x = this.exit.x * GRID_SIZE - this.camera_x;
      const exit_y = this.exit.y * GRID_SIZE - this.camera_y;
      this.exit.draw(ctx, exit_x, exit_y, GRID_SIZE);
    }
    
    const player_x = this.player.x * GRID_SIZE - this.camera_x;
    const player_y = this.player.y * GRID_SIZE - this.camera_y;
    this.player.draw(ctx, player_x, player_y, GRID_SIZE);
    
    this.draw_ui(ctx);
    
    if (Date.now() - this.message_time < 3000) {
      ctx.fillStyle = WHITE;
      ctx.font = "20px Arial";
      ctx.fillText(this.message, 10, SCREEN_HEIGHT - 40);
    }
    
    this.draw_minimap(ctx);
  }

  drawGameOverScreen(ctx: CanvasRenderingContext2D) {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
    
    ctx.fillStyle = WHITE;
    ctx.font = '48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('TIME UP!', SCREEN_WIDTH / 2, 100);
    ctx.font = '24px Arial';
    ctx.fillText('Your adventure has reached its limit', SCREEN_WIDTH / 2, 140);
    
    ctx.fillText(`Final Score: ${this.player.score}`, SCREEN_WIDTH / 2, 180);
    ctx.fillText(`Level Reached: ${this.dungeon_level}`, SCREEN_WIDTH / 2, 210);
    ctx.fillText(`Gold Collected: ${this.player.gold}`, SCREEN_WIDTH / 2, 240);
    
    ctx.font = '36px Arial';
    ctx.fillText('SCORE SUBMISSION', SCREEN_WIDTH / 2, 300);
    
    ctx.font = '20px Arial';
    if (this.isSubmittingScore) {
      ctx.fillStyle = YELLOW;
      ctx.fillText('Submitting score to blockchain...', SCREEN_WIDTH / 2, 350);
    } else {
      ctx.fillStyle = GREEN;
      ctx.fillText('Score submitted successfully!', SCREEN_WIDTH / 2, 350);
    }
    
    ctx.fillStyle = WHITE;
    ctx.font = '24px Arial';
    ctx.fillText('Press R to restart', SCREEN_WIDTH / 2, SCREEN_HEIGHT - 100);
    
    ctx.textAlign = 'left';
  }

  darkenColor(color: string): string {
    const num = parseInt(color.substring(1), 16);
    const r = Math.floor((num >> 16) / 2);
    const g = Math.floor(((num >> 8) & 0x00FF) / 2);
    const b = Math.floor((num & 0x0000FF) / 2);
    return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
  }  

  draw_ui(ctx: CanvasRenderingContext2D) {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.fillRect(0, SCREEN_HEIGHT - 100, SCREEN_WIDTH, 100);
  
    const centerX = SCREEN_WIDTH / 2;
    const uiTop = SCREEN_HEIGHT - 100;
    const textY = uiTop + 30;
    
    ctx.textAlign = "center";
    ctx.fillStyle = WHITE;
    ctx.font = "16px Arial";
    ctx.fillText(`Level: ${this.dungeon_level}`, centerX - 150, textY);
    
    const minutes = Math.floor(this.timeRemaining / 60000);
    const seconds = Math.floor((this.timeRemaining % 60000) / 1000);
    const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    ctx.fillStyle = this.timeRemaining < 30000 ? '#FF0000' : WHITE;
    ctx.fillText(`Time: ${timeText}`, centerX - 50, textY);
    
    ctx.fillStyle = YELLOW;
    ctx.fillText(`Gold: ${this.player.gold}`, centerX + 50, textY);
    
    ctx.fillStyle = GREEN;
    ctx.fillText(`Score: ${this.player.score}`, centerX + 150, textY);
    
    ctx.fillStyle = WHITE;
    ctx.fillText("WASD: Move", centerX, SCREEN_HEIGHT - 20);
    
    ctx.textAlign = "left";
  }

  draw_minimap(ctx: CanvasRenderingContext2D) {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
    ctx.fillRect(MINIMAP_POSITION.x, MINIMAP_POSITION.y, MINIMAP_WIDTH, MINIMAP_HEIGHT);
    
    const start_x = Math.max(0, this.player.x - Math.floor(MINIMAP_WIDTH / (2 * MINIMAP_CELL_SIZE)));
    const start_y = Math.max(0, this.player.y - Math.floor(MINIMAP_HEIGHT / (2 * MINIMAP_CELL_SIZE)));
    const end_x = Math.min(this.map_width, start_x + Math.floor(MINIMAP_WIDTH / MINIMAP_CELL_SIZE));
    const end_y = Math.min(this.map_height, start_y + Math.floor(MINIMAP_HEIGHT / MINIMAP_CELL_SIZE));
    
    for (let y = start_y; y < end_y; y++) {
      for (let x = start_x; x < end_x; x++) {
        if (this.tiles[y][x].explored) {
          const map_x = MINIMAP_POSITION.x + (x - start_x) * MINIMAP_CELL_SIZE;
          const map_y = MINIMAP_POSITION.y + (y - start_y) * MINIMAP_CELL_SIZE;
          
          let color;
          if (this.tiles[y][x].type === 0) color = this.wall_color;
          else if (this.tiles[y][x].type === 2) color = YELLOW;
          else color = this.floor_color;
          
          if (!this.tiles[y][x].visible) {
            color = this.darkenColor(color);
          }
          
          ctx.fillStyle = color;
          ctx.fillRect(map_x, map_y, MINIMAP_CELL_SIZE, MINIMAP_CELL_SIZE);
        }
      }
    }
    
    const player_map_x = MINIMAP_POSITION.x + (this.player.x - start_x) * MINIMAP_CELL_SIZE;
    const player_map_y = MINIMAP_POSITION.y + (this.player.y - start_y) * MINIMAP_CELL_SIZE;
    ctx.fillStyle = GREEN;
    ctx.fillRect(player_map_x, player_map_y, MINIMAP_CELL_SIZE, MINIMAP_CELL_SIZE);
    
    ctx.strokeStyle = WHITE;
    ctx.lineWidth = 1;
    ctx.strokeRect(MINIMAP_POSITION.x, MINIMAP_POSITION.y, MINIMAP_WIDTH, MINIMAP_HEIGHT);
  }

  destroy() {
    if (this.timerInterval) {
      clearInterval(this.timerInterval);
      this.timerInterval = null;
    }
    if (this.scoreManager) {
      this.scoreManager.destroy();
    }
  }
}

export default function DungeonCrawlerGame({ username }: { username: string }) {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const { authenticated, user, ready } = usePrivy();
  const [walletAddress, setWalletAddress] = useState<string>("");
  const gameRef = useRef<Game | null>(null);
  const animationRef = useRef<number | null>(null);
  const keysRef = useRef<Set<string>>(new Set());
  const [score, setScore] = useState(0);
  const [isSubmittingScore, setIsSubmittingScore] = useState(false);

  // Get wallet address
  useEffect(() => {
    if (!ready || !authenticated || !user) return;

    const crossAppAccount = user.linkedAccounts.find(
      (account) =>
        account.type === "cross_app" &&
        account.providerApp.id === "cmd8euall0037le0my79qpz42"
    ) as CrossAppAccountWithMetadata;

    if (crossAppAccount?.embeddedWallets.length > 0) {
      const address = crossAppAccount.embeddedWallets[0].address;
      setWalletAddress(address);
    }
  }, [ready, authenticated, user]);

  // Init game
  useEffect(() => {
    if (!walletAddress) return;

    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const gameUsername = username || `Player_${walletAddress.slice(0, 6)}`;
    gameRef.current = new Game(gameUsername, walletAddress);
    const game = gameRef.current;

    // Initialize sprites
    game.initializeSprites().then(() => {
      const handleKeyDown = (e: KeyboardEvent) => {
        const key = e.key.toLowerCase();
        keysRef.current.add(key);

        // Handle restart when game is over
        if (key === "r" && game.game_over) {
          if (gameRef.current) {
            gameRef.current.destroy();
          }
          const gameUsername = username || `Player_${walletAddress.slice(0, 6)}`;
          gameRef.current = new Game(gameUsername, walletAddress);
          gameRef.current.player.username = gameUsername;
          gameRef.current.initializeSprites();
          setScore(0);
        }
      };

      const handleKeyUp = (e: KeyboardEvent) => {
        keysRef.current.delete(e.key.toLowerCase());
      };

      window.addEventListener("keydown", handleKeyDown);
      window.addEventListener("keyup", handleKeyUp);

      const gameLoop = () => {
        const game = gameRef.current;
        if (!game) return;

        // Update score state for React
        if (game.player.score !== score) {
          setScore(game.player.score);
        }

        // Only process movement if game is not over
        if (!game.game_over) {
          const keys = keysRef.current;
          let dx = 0,
            dy = 0;

          if (keys.has("w") || keys.has("arrowup")) dy = -1;
          if (keys.has("s") || keys.has("arrowdown")) dy = 1;
          if (keys.has("a") || keys.has("arrowleft")) dx = -1;
          if (keys.has("d") || keys.has("arrowright")) dx = 1;

          if (dx !== 0 || dy !== 0) {
            game.move_player(dx, dy);
          }

          game.update_camera();
        }

        game.draw(ctx);
        animationRef.current = requestAnimationFrame(gameLoop);
      };

      animationRef.current = requestAnimationFrame(gameLoop);

      return () => {
        window.removeEventListener("keydown", handleKeyDown);
        window.removeEventListener("keyup", handleKeyUp);
        if (animationRef.current) {
          cancelAnimationFrame(animationRef.current);
        }
        if (gameRef.current) {
          gameRef.current.destroy();
        }
      };
    });
    
    return () => {
      if (animationRef.current) {
        cancelAnimationFrame(animationRef.current);
      }
      if (gameRef.current) {
        gameRef.current.destroy();
      }
      gameRef.current = null;
    };
  }, [walletAddress, username]);

  if (!walletAddress) {
    return (
      <div className="flex justify-center items-center h-screen bg-black">
        <p className="text-white">Loading game...</p>
      </div>
    );
  }

  return (
    <div className="flex flex-col items-center justify-center h-screen bg-black">
      <div className="flex items-center gap-4 mb-4">
        <div className="text-white text-2xl font-bold">Score: {score}</div>
        {isSubmittingScore && (
          <div className="text-yellow-400 text-sm">Submitting score...</div>
        )}
      </div>
      
      <canvas
        ref={canvasRef}
        width={SCREEN_WIDTH}
        height={SCREEN_HEIGHT}
        className="border border-gray-800"
      />
      
      <div className="mt-4 text-white text-sm">
        <p>WASD: Move • R: Restart</p>
        <p>Game: {GAME_CONFIG.METADATA.name}</p>
      </div>
    </div>
  );
}